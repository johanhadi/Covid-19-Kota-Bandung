---
title: "Statistik Covid-19 Kota Bandung (Update 10 Mei 2020)"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
runtime: shiny
---

```{r setup, include=FALSE}
#------------------ Packages ------------------
library(flexdashboard)
library(openxlsx)
library(leaflet)
library(shiny)
library(rgdal)
library(sp)
library(DT)
library(rpostgis)
library(htmltools)
library(rmarkdown)
library(knitr)
library(plotly)
#------------------ Warna ------------------
confirmed_color <- "purple"
active_color <- "#1f77b4"
recovered_color <- "forestgreen"
death_color <- "red"
#------------------ Data ------------------
bandung<- readOGR("D:/Kerjaan/Covid19/@" ,"kasus bandung")
batas <- readOGR("D:/Kerjaan/LNA", "Kota Bandung")
tabel <- read.xlsx("D:/covid-19.xlsx", sheet = "Prov")
topkec <- read.xlsx("D:/covid-19.xlsx", sheet = "Prov")
daily <- read.xlsx("D:/covid-19.xlsx", sheet = "Daily")


#------------------ Data ------------------
daily$Tanggal <- as.Date(daily$Tanggal, origin = "1899-12-30")
topkec$Kecamatan <- factor(topkec$Kecamatan, levels = unique(topkec$Kecamatan)[order(topkec$Total.Kasus, decreasing = TRUE)])
jumlahpositif <- 250
jumlahsembuh <- 38
jumlahmeninggal <- 34
jumlahtotal <- jumlahmeninggal +jumlahsembuh+jumlahpositif
```


Rangkuman {data-icon="fas fa-align-center"}
=======================================================================
Row
-----------------------------------------------------------------------
### Total Kasus
```{r}

valueBox(jumlahtotal, icon = "fas fa-user-md", color = "purple")
```

### Positif

```{r}
valueBox(jumlahpositif, icon = "fa-plus", color = "#1f77b4")
```

### Sembuh

```{r}
valueBox(jumlahsembuh, icon = "fa-medkit", color = "forestgreen")
```

### Meninggal

```{r}
valueBox(jumlahmeninggal, 
         icon = "fa-ambulance", color = "red")
```

### Layanan Kedaruratan

```{r}
layanan <- "119 atau 112"
valueBox(layanan, 
         icon = "fa-phone", color = "blue")

```

### Persentase Kesembuhan

```{r}
rate11 <- (jumlahsembuh/jumlahtotal)*100
rate1 <- round(rate11, digits = 2)
gauge(rate1, min = 0, max = 100, symbol = '%',  gaugeSectors(
  success = c(11, 100), warning = c(6, 10), danger = c(0, 5)
))
```

### Persentase Kematian

```{r}
rate22 <- (jumlahmeninggal/jumlahtotal)*100
rate2 <- round(rate22, digits = 2)
gauge(rate2, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(0, 5), warning = c(6, 10 ), danger = c(11, 100)
))
```

Row
-----------------------------------------------------------------------
### Kecamatan Dengan Total Kasus Terbanyak
```{r}
plot_ly(data = topkec , x = ~Kecamatan, y = ~Positif, 
                # text =  ~ Positif, 
                # textposition = 'auto',
                type = "bar", 
                name = "Positif",
                marker = list(color = active_color)) %>%
add_trace(y = ~Sembuh, 
                # text =  ~ Sembuh, 
                # textposition = 'auto',
                name = "Sembuh",
                    marker = list(color = recovered_color)) %>%
add_trace(y = ~Meninggal, 
              # text =  ~ Meninggal, 
              # textposition = 'auto', 
              name = "Meninggal",
                    marker = list(color = death_color)) %>%
layout(title = "", barmode = 'stack',
                 yaxis = list(title = "Total Kasus", range = c(0,40)),
                 xaxis = list(title = "Kecamatan",
                 hovermode = "compare", annotations = list(
                   xref = "paper",
                   yref = "paper",
                   showarrow = FALSE,
                   x = 0.95,
                   y = 1),
                 margin =  list(
                   # l = 60,
                   # r = 40,
                   b = 10,
                   t = 10,
                   pad = 2)))
```

Row
-----------------------------------------------------------------------
### Akumulasi Kasus Harian
```{r}
plot_ly(data = daily,
                x = ~Tanggal,
                y = ~Positif, 
                name = 'Positif', 
                fillcolor = active_color,
                type = 'scatter',
                mode = 'none', 
                stackgroup = 'one') %>%
add_trace(y = ~Sembuh,
                    name = "Sembuh",
                    fillcolor = recovered_color) %>%
add_trace(y = ~Meninggal,
                    name = "Meninggal",
                    fillcolor = death_color) %>%
layout(title = "",
                 yaxis = list(title = "Akumulasi Kasus"),
                 xaxis = list(title = "Tanggal"),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```

Peta Sebaran Covid-19 {data-icon="fa-map"}
=======================================================================
**Peta**
```{r}
label1 <- sprintf(
  "<center><strong>%s<strong>%s</center>","Status : ",
  bandung$Status
) %>% lapply(htmltools::HTML)
label2 <- sprintf(
  "<strong>%s<strong>%s<br/><strong>%s<strong>%s<br/><strong>%s<strong>%s<br/><strong>%s<strong>%s<br/>","Kecamatan ",
  batas$WADMKC, "Positif    : ", batas$Positif, "Sembuh : ", batas$Sembuh,"Meninggal : ", batas$Meninggal
) %>% lapply(htmltools::HTML)
actpal <- colorFactor(c("red","#1f77b4","forestgreen"), bandung$Status)
leaflet(data = bandung) %>%
  addProviderTiles("Stamen.TonerLite", group="Toner Lite") %>%
  addProviderTiles("Stamen.Toner", group="Toner") %>%
  addPolygons(data = batas, fillColor = "transparent", weight = 2 , color = "black", dashArray = 3,
              highlightOptions = highlightOptions(weight = 10, color = "red", fillColor = "yellow"),
              label = label2,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px")) %>%
  addCircleMarkers(data = bandung, label = label1,
                   color = ~actpal(Status),clusterOptions = markerClusterOptions(),
                   labelOptions = labelOptions(color = "red"))%>%
  addLegend(position = "bottomright", pal = actpal, values = ~Status, title = "Keterangan", opacity = 0.6) %>%
  addLayersControl(
    baseGroups = c("Toner Lite", "Toner"),options = layersControlOptions()) %>%
  addMiniMap(
    tiles = providers$Stamen.TonerLite,
    toggleDisplay = TRUE, position = "bottomleft")%>%
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom Kota Bandung",
    onClick=JS("function(btn, map){ map.setZoom(12); }")))
```

Grafik {data-icon="fas fa-chart-line"}
=======================================================================
Row {data-width=400}
-----------------------------------------------------------------------
### Grafik Kasus Positif
```{r}
plot_ly(data = daily) %>%
  add_trace(
    x = ~Tanggal,
    # y = ~Positif,
    y = ~Positif,
    type = "scatter",
    mode = "lines+markers",
    # name = "Total Kasus",
    name = "Total Kasus",
    line = list(color = active_color),
    marker = list(color = active_color)
  ) %>%
  add_annotations(
    x = as.Date("2020-04-22"),
    y = 182,
    text = "PSBB Bandung Raya",
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -50
  ) %>%
  add_annotations(
    x = as.Date("2020-03-17"),
    y = 1,
    text = "Kasus Positif Pertama",
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -50
  ) %>%
  layout(
    title = "",
    yaxis = list(title = "Kasus Positif"),
    xaxis = list(title = "Tanggal"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare")
```

Row {data-width=400}
-----------------------------------------------------------------------
### Grafik Kasus Sembuh
```{r}
plot_ly(data = daily) %>%
  add_trace(
    x = ~Tanggal,
    # y = ~Sembuh,
    y = ~Sembuh,
    type = "scatter",
    mode = "lines+markers",
    # name = "Sembuh",
    name = "Sembuh",
    line = list(color = confirmed_color),
    marker = list(color = confirmed_color)
  ) %>%
  add_annotations(
    x = as.Date("2020-04-22"),
    y = 35,
    text = "PSBB Bandung Raya",
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -50
  ) %>%
  add_annotations(
    x = as.Date("2020-03-17"),
    y = 1,
    text = "Kasus Sembuh Pertama",
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -50
  ) %>%
  layout(
    title = "",
    yaxis = list(title = "Kasus Sembuh"),
    xaxis = list(title = "Tanggal"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare")
```

Row {data-width=400}
-----------------------------------------------------------------------
### Grafik Kasus Meninggal
```{r}
plot_ly(data = daily) %>%
  add_trace(
    x = ~Tanggal,
    # y = ~Meninggal,
    y = ~Meninggal,
    type = "scatter",
    mode = "lines+markers",
    # name = "Meninggal",
    name = "Meninggal",
    line = list(color = active_color),
    marker = list(color = active_color)
  ) %>%
  add_annotations(
    x = as.Date("2020-04-22"),
    y = 32,
    text = "PSBB Bandung Raya",
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -50
  ) %>%
  add_annotations(
    x = as.Date("2020-03-23"),
    y = 1,
    text = "Kasus Meninggal Pertama",
    xref = "x",
    yref = "y",
    arrowhead = 5,
    arrowhead = 3,
    arrowsize = 1,
    showarrow = TRUE,
    ax = -10,
    ay = -50
  ) %>%
  layout(
    title = "",
    yaxis = list(title = "Kasus Meninggal"),
    xaxis = list(title = "Tanggal"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare")
```


Data {data-icon="fas fa-table"}
=======================================================================
### Tabel Covid-19 Kota Bandung
```{r}
datatable(tabel, options = list(
  bPaginate = FALSE
))
```